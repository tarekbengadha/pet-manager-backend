<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pet Manager - GitHub Backend</title>
    <style>
        /* Your existing styles */
        body { font-family: Arial, sans-serif; padding: 20px; }
        .auth-box { background: #f5f5f5; padding: 20px; margin-bottom: 20px; }
        .hidden { display: none; }
    </style>
</head>
<body>
    <!-- Simple Password Auth -->
    <div id="authBox" class="auth-box">
        <h2>Login</h2>
        <input type="password" id="userPassword" placeholder="Enter access password">
        <button onclick="login()">Login</button>
        <p><small>Default password: pet123</small></p>
    </div>

    <!-- Main App -->
    <div id="app" class="hidden">
        <button onclick="logout()" style="float:right;">Logout</button>
        <h1>Pet Manager</h1>
        
        <div>
            <h2>Add/Edit Pet</h2>
            <input type="hidden" id="petId">
            <input type="text" id="petName" placeholder="Name"><br>
            <input type="text" id="petSpecies" placeholder="Species"><br>
            <button onclick="savePet()">Save</button>
            <button onclick="deletePet()">Delete</button>
        </div>
        
        <h2>Pets List</h2>
        <div id="petsList"></div>
        
        <button onclick="saveToGitHub()">ðŸ’¾ Save to GitHub</button>
        
        <pre id="output"></pre>
    </div>

    <script>
        // Configuration
        const GITHUB_OWNER = 'tarek-bg';  // Your GitHub username
        const GITHUB_REPO = 'web';        // Your repository name
        const DATA_PATH = '1data/pets-data.json';
        const ACCESS_PASSWORD = 'pet123'; // Change this!
        
        let pets = [];
        let isAuthenticated = false;

        // Simple password authentication
        function login() {
            const password = document.getElementById('userPassword').value;
            if (password === ACCESS_PASSWORD) {
                isAuthenticated = true;
                document.getElementById('authBox').classList.add('hidden');
                document.getElementById('app').classList.remove('hidden');
                loadData();
            } else {
                alert('Wrong password!');
            }
        }
        
        function logout() {
            isAuthenticated = false;
            document.getElementById('authBox').classList.remove('hidden');
            document.getElementById('app').classList.add('hidden');
        }

        // Load data from GitHub Pages
        async function loadData() {
            try {
                const response = await fetch(`https://${GITHUB_OWNER}.github.io/${GITHUB_REPO}/${DATA_PATH}`);
                const data = await response.json();
                pets = data.pets || [];
                renderPets();
            } catch (error) {
                console.error('Error loading:', error);
                pets = [];
            }
        }

        // Save to GitHub via GitHub Actions
        async function saveToGitHub() {
            if (!isAuthenticated) return alert('Please login first');
            
            const data = {
                pets: pets,
                updated: new Date().toISOString()
            };
            
            try {
                // Save to GitHub via repository_dispatch
                const response = await fetch(`https://api.github.com/repos/${GITHUB_OWNER}/${GITHUB_REPO}/dispatches`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `token ${localStorage.getItem('github_token')}`,
                        'Accept': 'application/vnd.github.v3+json'
                    },
                    body: JSON.stringify({
                        event_type: 'update-pets',
                        client_payload: { data: JSON.stringify(data, null, 2) }
                    })
                });
                
                if (response.ok) {
                    alert('âœ… Changes queued for GitHub!');
                } else {
                    alert('âŒ Error saving');
                }
            } catch (error) {
                console.error('Error:', error);
                alert('Error saving to GitHub');
            }
        }

        // Local CRUD operations
        function savePet() {
            const id = document.getElementById('petId').value;
            const pet = {
                name: document.getElementById('petName').value,
                species: document.getElementById('petSpecies').value
            };
            
            if (id) {
                // Update
                const index = pets.findIndex(p => p.id === id);
                if (index !== -1) {
                    pets[index] = { ...pets[index], ...pet };
                }
            } else {
                // Add new
                pet.id = Date.now().toString();
                pets.push(pet);
            }
            
            renderPets();
            clearForm();
        }
        
        function renderPets() {
            const container = document.getElementById('petsList');
            container.innerHTML = pets.map(pet => `
                <div style="border:1px solid #ccc; padding:10px; margin:5px;">
                    <strong>${pet.name}</strong> (${pet.species})
                    <button onclick="editPet('${pet.id}')">Edit</button>
                </div>
            `).join('');
            
            document.getElementById('output').textContent = JSON.stringify(pets, null, 2);
        }
        
        function editPet(id) {
            const pet = pets.find(p => p.id === id);
            if (pet) {
                document.getElementById('petId').value = pet.id;
                document.getElementById('petName').value = pet.name;
                document.getElementById('petSpecies').value = pet.species;
            }
        }
        
        function deletePet() {
            const id = document.getElementById('petId').value;
            if (id && confirm('Delete this pet?')) {
                pets = pets.filter(p => p.id !== id);
                renderPets();
                clearForm();
            }
        }
        
        function clearForm() {
            document.getElementById('petId').value = '';
            document.getElementById('petName').value = '';
            document.getElementById('petSpecies').value = '';
        }

        // Initialize
        document.addEventListener('DOMContentLoaded', () => {
            // Check if already logged in (simple session)
            if (localStorage.getItem('pet_logged_in') === 'true') {
                login();
            }
        });
    </script>
</body>
</html>
